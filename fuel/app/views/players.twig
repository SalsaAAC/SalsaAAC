{% extends "template.twig" %}

{% block title %}Players{% endblock %}

{% block content %}
		<fieldset id="search" class="list_left"> <!-- to make two field float next to one another, adjust values accordingly -->
			<label>Search</label>
			<div id="1" style="container">
                                <div style="width:12%; margin:0 8px; display: inline-block"></div>
                        
				<select id="field1" class="field">
					<option value="name">Name</option>
					<option value="account">Account</option>
					<option value="lastlogin">Last login</option>
					<option value="level">Level</option>
					<option value="group_id">Group</option>
				</select>
				<select id="operator1" class="operator">
					<option value="=">=</option>
					<option value="!=">!=</option>
					<option value=">">></option>
					<option value="<"><</option>
				</select>
				<div style="display: inline"><input id="filter_val1" class="filter_val" type="text" value=""></div>
				<a href="#" id="add"><img src="{{baseurl}}resources/admin/img/icons/plus_alt_16x16.png"></a>
			</div>
                        <div class="clear"></div>
		</fieldset>
		<fieldset class="list_right"> <!-- to make two field float next to one another, adjust values accordingly -->
			<label>Order by</label>
			<select id="sortby" class="sortby">
				<option value="name">Name</option>
				<option value="lastlogin">Last login</option>
				<option value="level">Level</option>
			</select>
			<select id="order" class="order">
				<option value="asc">Ascending</option>
				<option value="desc">Descending</option>
			</select>
		</fieldset><div class="clear"></div>

		<div id="loading" style="display: none"><img src="{{baseurl}}resources/admin/img/ajax-loader.gif"></div>
		<article class="module width_full">
		<header>
			<h3 class="tabs_involved">Players</h3>
                        <button id="apply_btn" class="button"><span class="magnifier icon"></span>Apply filters</button>
                        <button id="go_btn" class="button"><span class="rightarrow icon"></span>Go</button>
			<input id="gopage" type="text">
			<div id="menu"></div>
		</header>

		<div class="tab_container">
			<table class="tablesorter" cellspacing="0"> 
			<thead> 
				<tr>
                                <th><input type="checkbox" id="checkpage" page="1"/></th>
    				<th>Name</th> 
    				<th>Account</th> 
    				<th>Last login</th> 
    				<th>Level</th>  
    				<th>Group</th> 
    				<th>Flags</th> 
				</tr> 
			</thead> 
			<tbody> 
			</tbody> 
			</table>
			</div><!-- end of #tab1 -->	
			<footer>
				<div class="submit_link_left">
                                        <button id="selectall" class="button">Select all</button>
					<button class="button">Go</button>
				</div>
			</footer>	
		</div><!-- end of .tab_container -->
		
		</article><!-- end of content manager article -->
{% endblock %}
{% block script%}
<script type="text/javascript">
$(document).ready(function () {	
	var filters_num = 1;
	var pages = 0;
        var pids = Array();
        var all_pids = Array();
        var pages_checked = Array();

	function getfilters()
	{
		var output = '';

		$('fieldset#search div').each(function(index) {
			var id = $(this).attr('id');
			if ($('#filter_val'+id).val() != '')
			{
				output += '&criterium'+id+'='+$('select#criterium'+id).val()+'&field'+id+'='+$('select#field'+id).val()+'&operator'+id+'='+$('select#operator'+id).val()+'&filter_val'+id+'='+$('#filter_val'+id).val();
			}
		});

		return output;
	}

	function loadData(page)
	{
		$('#loading').css('margin-left', $('section[id="main"]').width()/2 - 20);
		$('#loading').fadeIn('fast');
		$.ajax({
			type: "POST",
			url: "/adminactions/getplayerslist.json",
			data: "page="+page+"&sortby="+$('select#sortby').val()+"&order="+$('select#order').val()+getfilters(),
			async: false,
    			dataType: "json",
			success: function(data)
			{
				$('#loading').fadeOut();
				$("tbody").html(data.message);
				$("#menu").html(data.menu);
				$('#sidebar').height($(document).height()-90);
				$('#main').height($(document).height()-90);
				$("#menu").css('margin-left', $(".tab_container").width()/2 - 106 - 9*data.max);
				$("#menu").css('width', 230 + 12*data.max);
				pages = data.max;
                                all_pids = data.allpids;

                                $('input#checkpage').attr('page', page);
                                if (pages_checked.indexOf(page) > -1)
                                {
                                        $('input#checkpage').attr('checked', true);
                                }
                                else
                                {
                                        $('input#checkpage').attr('checked', false);
                                }
                                $('input#pid').each(function(index) {
                                        if (pids.indexOf($(this).attr('pid')) > -1)
                                        {
                                                $(this).attr('checked', true);
                                        }
                                });
			}
		});
	}

	function groupsList(number, field)
	{
		$.ajax({
			type: "POST",
			url: "/adminactions/getgroupslist.json",
			data: "number="+number,
			async: false,
    			dataType: "json",
			success: function(data)
			{
				field.parent().html(data.select);
			}
		});
	}

        function selectVisible()
        {
                $('input#pid').each(function(index) {
                        $(this).attr('checked', true);
                        insert(pids, $(this).attr('pid'));
                });
        }

        function deselectVisible()
        {
                $('input#pid').each(function(index) {
                        $(this).attr('checked', false);
                        pids.splice(pids.indexOf($(this).attr('pid')), 1); 
                });
        }

        function getSelectedItems()
        {
                return pids.join('~');
        }

	loadData(1);

	$('select[id^="field"]').live('change',function(){
		var number = $(this).parent().attr('id');

                if (number == 1)
                {
		        $("#filter_val"+number).parent().html('<input id="filter_val'+number+'" class="filter_val" type="text" value="">');
                }
                else
                {
		        $("#filter_val"+number).parent().html('<input id="filter_val'+number+'" class="filter_val" type="text" style="margin-top:6px;margin-left:5px" value="">');
                }

		if ($(this).val() == 'lastlogin')
		{
			$(this).parent().find("#filter_val"+number+":first").datepicker({
				dateFormat: 'd MM yy',
				altField: $(this).parent().find("#filter_val"+number+":first")
			});
		}
		else
		{
			$(this).parent().find("#filter_val"+number+":first").datepicker( "destroy" );
		}

		if ($(this).val() == 'group_id')
		{
			groupsList(number, $(this).parent().find("#filter_val"+number+":first"));
		}
	});

	$('#menu ul#pagination li a').live('click',function(){
		var page = $(this).parent().attr('p');
		loadData(page);
	});
	$('article.module header button#apply_btn').live('click',function(){
		loadData(1);
		return true;
	});

	$('fieldset a#remove').live('click',function(){
		$(this).parent().remove();
		filters_num -= 1;		
	});

	$('button#go_btn').live('click',function(){
		var page = $('input#gopage').val();
		if (isNaN(page) || page > pages || page <= 0) return false;
		else
		{
			loadData(page);		
		}
	});

	$('fieldset a#add').live('click',function(){
		if (filters_num < 5)
		{
			filters_num += 1;
			$('fieldset#search').append('<div id="'+filters_num+'" class="container"><select id="criterium'+filters_num+'" class="criterium" style="margin-top: 8px"><option value="AND">AND</option><option value="OR">OR</option></select><select id="field'+filters_num+'" class="field" style="margin-top: 8px"><option value="name">Name</option><option value="account">Account</option><option value="lastlogin">Last login</option><option value="level">Level</option><option value="group_id">Group</option></select><select id="operator'+filters_num+'" class="operator" style="margin-top: 8px; margin-left: 7px"><option value="=">=</option>	<option value="!=">!=</option><option value=">">></option><option value="<"><</option></select>'+
			'<a href="#" id="remove" style="margin: 10px 8px 0 0"><img src="{{baseurl}}resources/admin/img/icons/x_alt_16x16.png"></a><div style="display: inline"><input id="filter_val'+filters_num+'" class="filter_val" type="text" style="margin-top:6px;margin-left:4px" value=""></div></div>');
		}
	});

	$('input#pid').live('click',function(){
                if ($(this).attr('checked'))
                {
                        insert(pids, $(this).attr('pid'));
                }
                else
                {
                        pids.splice(pids.indexOf($(this).attr('pid')), 1);
                        $('input#checkpage').attr('checked', false); 
                        pages_checked.splice(pages_checked.indexOf($(this).attr('page')), 1);
                }
        });        
	$('input#checkpage').live('click',function(){
                if ($(this).attr('checked'))
                {
                        selectVisible();
                        insert(pages_checked, $(this).attr('page'));
                }
                else
                {
                        deselectVisible();
                        pages_checked.splice(pages_checked.indexOf($(this).attr('page'), 1));
                }
        }); 

	$('button#selectall').live('click',function(){
                pids = pids.concat(all_pids);
                for(i=pages; i>0; i--) { 
                        insert(pages_checked, i.toString());
                }
                selectVisible();
                $('input#checkpage').attr('checked', true);
        }); 

        function insert(array, item)
        {
                if (array.indexOf(item) < 0)
                {
                        array.push(item);
                }
        }
});
</script>
{% endblock %}
